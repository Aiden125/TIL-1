> 출저 [AWS 시스템 설계와 마이그레이션](http://www.kyobobook.co.kr/product/detailViewKor.laf?ejkGb=KOR&mallGb=KOR&barcode=9791158391201&orderClick=LAG&Kc=)을 보고 정리한 내용입니다.

# 목차
- [목차](#%EB%AA%A9%EC%B0%A8)
- [윕 가용성 향상 패턴](#%EC%9C%95-%EA%B0%80%EC%9A%A9%EC%84%B1-%ED%96%A5%EC%83%81-%ED%8C%A8%ED%84%B4)
  - [ELB](#elb)
  - [ELB 자체의 확장 : 스케일링](#elb-%EC%9E%90%EC%B2%B4%EC%9D%98-%ED%99%95%EC%9E%A5--%EC%8A%A4%EC%BC%80%EC%9D%BC%EB%A7%81)
  - [상태 확인 기능](#%EC%83%81%ED%83%9C-%ED%99%95%EC%9D%B8-%EA%B8%B0%EB%8A%A5)
  - [상태 유지 세션](#%EC%83%81%ED%83%9C-%EC%9C%A0%EC%A7%80-%EC%84%B8%EC%85%98)
  - [Auto Scaling](#auto-scaling)
    - [Scaling 정책/계획](#scaling-%EC%A0%95%EC%B1%85%EA%B3%84%ED%9A%8D)
      - [수동 스케일](#%EC%88%98%EB%8F%99-%EC%8A%A4%EC%BC%80%EC%9D%BC)
      - [자동 스케일링](#%EC%9E%90%EB%8F%99-%EC%8A%A4%EC%BC%80%EC%9D%BC%EB%A7%81)
      - [스케줄 기반](#%EC%8A%A4%EC%BC%80%EC%A4%84-%EA%B8%B0%EB%B0%98)
      - [규칙 기반](#%EA%B7%9C%EC%B9%99-%EA%B8%B0%EB%B0%98)

# 윕 가용성 향상 패턴

웹 서비스, 업무용 시스템에 관계 없이 시스템은 요청이 쇄도하는 `피크 시간`이 있습니다. 피크 시간은 시스템 특성 계정, 요일 등의 시작적욘 요인 이나 돌발적인 요인등 다양한 요인이 얽혀 날마다 변화하기 때문에 예사아힉 어렵고, 설계 시 엔지니어들을 고민하게 만드는 요인입니다.

온프레미스 시스템을 구축할 경우 과거 정보에 의해서 요청 수를 책상 위에서 예측하고 거기에 일정량의 여유율을 곱해서 서버 사양을 결정합니다. 하지만 이런 예상은 매우 어렵고 요청 수가 예상을 뛰어넘어 장애의 원인이 되거나 예상을 밑돌아 인프라 리소스를 낭비하기도 합니다.


## ELB
ELB 하위에 여러 EC2 인스턴스를 연결하고, 요청을 각 인스턴스에 분산시킵니다. AWS ELB는 관리 콘솔이나 AWS API를 사용해서 쉽게 짧은 리드 타임으로 로드 밸런서 기능을 사용할 수 있습니다.

ELB에는 표준 로드 밸런스 CLB, ABL 라는 로드 밸런서가 있습니다. 여기서는 최근에 릴르즈된 기능도 풍부한 ALB를 사용한다고 전제하고 설명하겠습니다.

## ELB 자체의 확장 : 스케일링
어느 정도의 엑세스 증가를 `급격`한 증가라고 판단하는 가가 중요한데 AWS의 문서에서에 따르면 5분에 50%이상 트래픽이 늘어나느 경우에 사전 워밍 신청을 해야한다고 나와있습니다. 

## 상태 확인 기능
ELB에는 관리하고 있는 EC2 인스턴스가 제대로 동작하고 있는지를 확인하는 기능이 있습니다. 제대로 동작하지 않은 인스턴스는 포기하고 요청을 보내지 않도록하고, Auto Scaling 기능과 연계해서 제외한 만큼 인스턴스를 보충할 수 있기 때문에 트러블에 영향이 사용자에게 미치치 않습니다.

상태 확인은 다음과 같은 매개변수를 정의 할 수 있기 때문에 시스템 특성에 따라 튜닝할 수 있습니다.
* 어떤 파일을 확인하는가?
* 몇 초 마다 파일을 확인하는가
* 몇 번연속으로 엑세스 실패하면 분리하는가
* 몇 번 연속으로 섹세스 성공하면 연결하는가

## 상태 유지 세션
ELB가 관리하는 여러 대의 EC2 인스턴스가 있는 경우, 동일한 이용자가 요청할 때마다 엑세스하는 인스터늣가 바뀔 가능성이 있습니다. 따라서 로그인 후 액세스하려는 서버에 세션 정보가 없는 있고, 그 떄는 기대한 처리를 실행ㄹ할 수 없게 됩니다.

상태 유지 세션은 동일한 사용자의 요청을 모두 같은 EC2 인스턴스에게 분배하는 기능입니다.

그러나 사용자는 원래부터 엑세스하고 있던 인스턴스에 처리가 계속해서 할당되게 됩니다. 이런구조는 인스턴스가 늘려도 효과를 보기가 어렵습니다. 반대로 인스턴스의 수가 감소한 경우 해당 인스턴스에 처리된 사용자의 상태 정보가 사라지므로 계속해서 처리를 못할 수 있습니다.

## Auto Scaling
Auto Scaling은 서버의 이용 상황에 따라 자동으로 서버의 수를 증가시키는 기능입니다. 

### Scaling 정책/계획

#### 수동 스케일
가장 쉬운 스케일 방식 희망 대수를 수동으로 변경하면 그 대수가 되도록 스케일 할 수 있습니다. 최소 대수보다 적은 대수,최대 대수보다 많은 대수로 설저하는 것은 불가능합니다.

#### 자동 스케일링
최소 대수를 희망 대수 값과 동일하게 설정해 초기의 인스턴스 대수를 유지하는 방식입니다. Auto Scaling 그룹 인스턴스에 뭔가 문제가 발생하고 유요한 인스턴스의 수가 줄었을 때 자동으로 인스턴스가 구축되는, 최소한으로 필요한 인스턴스 대수를 유지하는 방식입니다.

#### 스케줄 기반
설저한 시간에 맞춰 서버 대수를 증감시키는 방식 18 시부터 22시 까지 요청이 많은 서비스에 대해서 17:55에 인스턴스를 8대로 한다. 등 같은 피크 시간이 왔다 갔다 하거나 인스턴스를 시작하는데 시간이 걸리는 것을 고려해서 시간을 결정해야 합니다.

#### 규칙 기반
서비스의 이용 상황에 따라 동적으로 대수를 증감시크는 방식입니다. 예를 들면 

> CPU의 평균 사용률이 70%를 넘으면 2대의 인스턴스를 늘리겠다.
> 
> 일단 CPU의 평균 사용률이 50%를 넘으면 1대 추가, 거기서 80%를 넘으면 1대 또 추가

피크 시간을 예측하기 어려운 경우에 유요한 설정이라고 할 수 있습니다.

규칙 기반 Scaling 정책 설정은 스케일 인 조건도 설정할수있습니다. 위 조건과 반대로 CPU 사용률이 떨어지면 1대 스케일 인 같은 설정을 할 수 있습니다.

이런 설정을 자주하면 스케일 아웃/인이 반복될 위험이있습니다.